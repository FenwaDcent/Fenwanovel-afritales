<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Read â€“ Fenwanovels</title>
  <link rel="stylesheet" href="style.css">
</head>
<body data-theme="dark">
  <header class="topbar">
    <a href="index.html" class="brand">Fenwanovels</a>
    <div class="actions">
      <button id="themeToggle" class="btn ghost">ðŸŒ™</button>
      <button id="logoutBtn" class="btn danger" hidden>Logout</button>
    </div>
  </header>

  <main class="container">
    <article id="bookArea" class="book-area"></article>
  </main>

  <script type="module">
    import { auth, onAuthStateChanged, signOut } from './firebase.js';

    const area = document.getElementById('bookArea');
    const logoutBtn = document.getElementById('logoutBtn');
    const themeToggle = document.getElementById('themeToggle');

    // theme
    const saved = localStorage.getItem('theme');
    if(saved) document.body.dataset.theme = saved;
    themeToggle.addEventListener('click', ()=>{
      document.body.dataset.theme = document.body.dataset.theme==='dark' ? 'light' : 'dark';
      localStorage.setItem('theme', document.body.dataset.theme);
    });

    // auth gate
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        const id = new URLSearchParams(location.search).get('id') || '';
        location.href = `login.html?returnTo=${encodeURIComponent('book.html?id='+id)}`;
        return;
      }
      logoutBtn.hidden = false;
      await loadBook();
    });

    logoutBtn.addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));

    async function loadBook(){
      const id = new URLSearchParams(location.search).get('id');
      if(!id){ area.innerHTML = `<p class="error">Missing book id.</p>`; return; }
      try{
        const res = await fetch(`books/${id}.json?v=${Date.now()}`);
        if(!res.ok) throw new Error('Book not found.');
        const book = await res.json();

        area.innerHTML = `
          <div class="hero">
            <img src="${book.cover}" alt="${book.title} cover">
            <div>
              <h1>${book.title}</h1>
              <p class="muted">by ${book.author}</p>
              <div class="tags">${(book.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
            </div>
          </div>
          <div class="chapters" id="chapters"></div>
        `;

        const wrap = document.getElementById('chapters');
        book.chapters.forEach(ch=>{
          const sec = document.createElement('section');
          sec.className = 'chapter';
          sec.innerHTML = `<h3>${ch.title}</h3><div class="content">${ch.text}</div>`;
          wrap.appendChild(sec);
        });
      }catch(e){
        area.innerHTML = `<p class="error">${e.message}</p>`;
      }
    }
  </script>
</body>
</html>
